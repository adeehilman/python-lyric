<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>
  <meta name="description" content="Lyrics player" />
  <style>
    :root{
      --bg-blur: 10px;
      --text-normal: 1rem;
      --text-active: clamp(1.8rem, 4vw, 3rem);
      --text-faded: 0.7;
      --accent: #fff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, sans-serif;
      color: #fff; background: #000; overflow: hidden;
    }
    .bg {
      position: fixed; inset: 0;
      background: url('{{ cover_url }}') center/cover no-repeat fixed;
      filter: blur(var(--bg-blur)) brightness(0.5);
      transform: scale(1.06);
    }
    .overlay { position: fixed; inset:0; background: radial-gradient(transparent, rgba(0,0,0,0.7)); }
    .app {
      position: relative; height: 100%; display: grid;
      grid-template-rows: auto 1fr auto; gap: 12px; padding: 16px;
    }
    .boom {
        animation: pulse 0.4s ease;
        }
        @keyframes pulse {
        0%   { transform: scale(1);   }
        30%  { transform: scale(1.15);}
        60%  { transform: scale(0.95);}
        100% { transform: scale(1);   }
        
    }

    .photo-3d {
  width: min(60vw, 280px);
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5),
              0 0 30px rgba(255,255,255,0.25);
  transform: perspective(800px) rotateY(0deg) rotateX(0deg) scale(1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.photo-3d:hover {
  transform: perspective(800px) rotateY(5deg) rotateX(5deg) scale(1.05);
  box-shadow: 0 12px 40px rgba(0,0,0,0.6),
              0 0 50px rgba(255,255,255,0.4);
}


    .flash::after {
  content:"";
  position:fixed; inset:0;
  background:#fff;
  opacity:0; pointer-events:none;
  animation: flashAnim 0.25s ease;
}
@keyframes flashAnim { 
  0%{opacity:0.6;} 100%{opacity:0;} 
}

    header, footer { display: flex; align-items: center; justify-content: space-between; }
    header .meta { display: flex; gap: 12px; align-items: center; }
    header img.cover {
      width: 44px; height: 44px; border-radius: 8px; object-fit: cover; box-shadow: 0 4px 20px rgba(0,0,0,0.35);
    }
    header .title { font-weight: 700; }
    .controls { display: flex; gap: 8px; align-items: center; }
    button, input[type="range"] {
      appearance: none; border: 0; outline: 0;
      background: rgba(255,255,255,0.12); color: #fff; border-radius: 999px; padding: 8px 14px; cursor: pointer;
    }
    input[type="range"] { width: min(380px, 60vw); padding: 0; height: 6px; }
    .lyrics-wrap {
      overflow: hidden; position: relative; display: grid; place-items: center;
    }
    .lyrics {
      width: min(900px, 92vw); max-height: 70vh; overflow: hidden; padding: 8px 0;
      scroll-behavior: smooth;
    }
    .line {
      padding: 10px 6px; line-height: 1.35; opacity: var(--text-faded);
      font-size: clamp(1rem, 2.2vw, 1.4rem); transition: all 240ms ease;
      text-align: center; white-space: pre-wrap; word-break: break-word;
    }
    .line.active {
      opacity: 1; font-weight: 800; font-size: var(--text-active);
      text-shadow: 0 2px 24px rgba(255,255,255,0.28);
    }
    .time {
      font-variant-numeric: tabular-nums; font-size: 0.8em; opacity: 0.6;
      margin-right: 8px; display: none; /* set ke inline kalau mau tampil timestamp */
    }
    .hint { opacity: 0.7; font-size: 0.9rem; }
    .hidden { display: none !important; }

    @keyframes boomPulse {
  0%   { transform: scale(1);   }
  30%  { transform: scale(1.18);}
  60%  { transform: scale(0.92);}
  100% { transform: scale(1);   }
}

.boom {
   animation: boomPulse 0.35s ease;
}

.flash::after {
  content:"";
  position:fixed; inset:0;
  background:white;
  opacity:0; pointer-events:none;
  animation: flashAnim 0.2s ease;
}
@keyframes flashAnim {
  0% { opacity:0.6; }
  100% { opacity:0; }
}

.lyrics-wrap {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  z-index: 10; /* pastikan di atas foto/objek lain */
}

.lyrics {
  width: min(900px, 92vw);
  max-height: 70vh;
  overflow-y: hidden; /* cegah scroll manual menimpa */
  scroll-behavior: smooth;
  position: relative;
  z-index: 20;
}

.photo-3d {
  z-index: 5;
  position: relative;
}
/* Mobile-friendly tweaks */
@media (max-width: 768px) {
  body {
    padding: 0;
    margin: 0;
  }

  header, footer {
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .photo-wrap {
    margin: 8px 0;
    display: flex;
    justify-content: center;
  }

  .photo-3d {
    width: 50vw;          /* gambar otomatis 50% lebar layar */
    max-width: 160px;     /* jangan lebih besar dari 160px */
    height: auto;
    z-index: 5;
  }

  .lyrics-wrap {
    margin-top: 10px;
    margin-bottom: 10px;
    max-height: 55vh;     /* biar lirik punya ruang lebih */
    overflow: hidden;
  }

  .lyrics {
    max-height: inherit;
    padding: 0 8px;
    font-size: 0.95rem;
  }

  .line {
    font-size: 1rem;
    padding: 6px;
  }

  .line.active {
    font-size: 1.4rem;
  }

  .controls {
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
  }

  button, input[type="range"] {
    font-size: 0.85rem;
  }

  input[type="range"] {
    width: 90%;
  }
}

footer {
  margin-bottom: 10px;
}

.lyrics { position: relative; z-index: 10; }
.photo-3d {
  display: block;
  width: auto;           /* biar nggak melar */
  height: auto;          /* biar nggak gepeng */
  max-width: 60vw;       /* batas lebar relatif */
  max-height: 160px;     /* batas tinggi biar nggak nutup lyric */
  border-radius: 20px;
  object-fit: cover;     /* jaga proporsi isi */
  box-shadow: 0 8px 25px rgba(0,0,0,0.5),
              0 0 30px rgba(255,255,255,0.25);
  z-index: 5;
}

@media (max-width: 768px) {
  .photo-3d {
    max-width: 50vw;    /* relatif ke layar */
    max-height: 140px;  /* jangan terlalu tinggi */
  }
}

/* Aturan umum untuk layar kecil */
@media (max-width: 576px) {
    /* Table horizontal scroll */
    #employees-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    /* Tombol aksi ditumpuk */
    #employees-table td .btn {
        display: block;
        width: 100%;
        margin-bottom: 5px;
    }

    /* Card summary lebih rapat */
    #summary-cards .col-sm-6 {
        margin-bottom: 10px;
    }

    /* Modal agar full width di mobile */
    .modal-dialog {
        max-width: 95%;
        margin: 10px auto;
    }
}

/* Umum untuk layar kecil */
@media (max-width: 576px) {
    .lyric-photo {
        display: block;
        max-width: 90%;
        height: auto;
        margin: 0 auto 15px auto;
        border-radius: 12px;
    }

    /* Pastikan teks tidak overlap gambar */
    #deleteMessage, #lyrics-container {
        margin-top: 15px;
    }
}

/* Khusus untuk iPhone 11 (414px × 896px, DPR 2) */
@media only screen 
  and (device-width: 414px) 
  and (device-height: 896px) 
  and (-webkit-device-pixel-ratio: 2) {
    
    .lyric-photo {
        max-width: 80%;       /* biar lebih kecil di layar */
        height: auto;
        object-fit: cover;    /* gambar tetap proporsional */
        margin: 10px auto;
    }

    .lyric-container {
        padding: 0 10px;      /* kasih napas di kanan kiri */
    }

    .lyric-line {
        font-size: 15px;      /* sedikit lebih kecil biar pas di layar */
        line-height: 1.4em;
    }
}

  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="overlay" aria-hidden="true"></div>
    
  <div class="app">
    <header>
      <div class="meta">
        <img class="cover" src="{{ cover_url }}" alt="Cover">
        <div>
          <div class="title">{{ title }}</div>
          <div class="subtitle">{{ artist }}</div>
        </div>
      </div>
      <div class="controls">
        <button id="play">Play</button>
        <button id="pause">Pause</button>
        <input id="seek" type="range" min="0" max="1000" value="0" step="1" />
        <span id="clock" class="hint">00:00 / 00:00</span>
      </div>
    </header>
<div class="photo-wrap">
  <img src="{{ cover_url }}" alt="Cover"  class="lyric-photo" id="pulse-photo">
</div>

<div class="lyrics-wrap">
  <div id="lyrics" class="lyrics"></div>
</div>



    <footer>
      <div class="hint">Space = Play/Pause • ←/→ = -/+ 5s</div>
      <audio id="audio" src="{{ audio_url }}" preload="metadata"></audio>
    </footer>
  </div>

  <script>
    const AUDIO_SRC = "{{ audio_url }}";
    const DATA = {{ data_json | safe }};

    // DOM
    const audio = document.getElementById('audio');
    const lyricsEl = document.getElementById('lyrics');
    const playBtn = document.getElementById('play');
    const pauseBtn = document.getElementById('pause');
    const seek = document.getElementById('seek');
    const clock = document.getElementById('clock');


    // Beat otomatis tiap 1 detik sekali
setInterval(() => {
  if (!audio.paused) {
    triggerBoom();
  }
}, 1000);

// Klik foto → jedag-jedug
const photo = document.getElementById('pulse-photo');
photo.addEventListener('click', () => {
  photo.classList.add('boom');
  setTimeout(() => photo.classList.remove('boom'), 400);
});

// Modifikasi triggerBoom supaya juga ke foto
function triggerBoom() {
  const active = document.querySelector('.line.active');
  const photo = document.getElementById('pulse-photo');

  [active, photo].forEach(el => {
    if (el) {
      el.classList.add('boom');
      setTimeout(() => el.classList.remove('boom'), 400);
    }
  });
}

function setActive(idx) {
  if (idx === activeIdx) return;
  const prev = lyricsEl.querySelector('.line.active');
  if (prev) prev.classList.remove('active');

  const next = lyricsEl.querySelector(`.line[data-index="${idx}"]`);
  if (next) {
    next.classList.add('active');
    // auto focus ke tengah viewport container
    next.scrollIntoView({
      behavior: 'smooth',
      block: 'center',
      inline: 'nearest'
    });
  }
  activeIdx = idx;
}


    // Render lines
    DATA.forEach((item, idx) => {
      const line = document.createElement('div');
      line.className = 'line';
      line.dataset.start = item.start.toString();
      line.dataset.index = idx.toString();

      const time = document.createElement('span');
      time.className = 'time';
      time.textContent = fmtTime(item.start);

      const text = document.createElement('span');
      text.textContent = item.text || '';

      line.appendChild(time);
      line.appendChild(text);
      lyricsEl.appendChild(line);
    });

    let activeIdx = -1;
    let duration = 0;

    audio.addEventListener('loadedmetadata', () => {
      duration = audio.duration || 0;
      updateClock();
    });

    playBtn.onclick = () => audio.play();
    pauseBtn.onclick = () => audio.pause();

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') { e.preventDefault(); audio.paused ? audio.play() : audio.pause(); }
      if (e.code === 'ArrowLeft') { audio.currentTime = Math.max(0, audio.currentTime - 5); }
      if (e.code === 'ArrowRight') { audio.currentTime = Math.min(duration, audio.currentTime + 5); }
    });

    // Seek bar
    audio.addEventListener('timeupdate', () => {
      if (duration) seek.value = Math.round((audio.currentTime / duration) * 1000);
      syncLyrics(audio.currentTime);
      updateClock();
    });
    seek.addEventListener('input', () => {
      if (!duration) return;
      audio.currentTime = (seek.value / 1000) * duration;
    });

    function syncLyrics(t) {
      // binary search untuk baris aktif
      let lo = 0, hi = DATA.length - 1, idx = 0;
      while (lo <= hi) {
        const mid = (lo + hi) >> 1;
        if (DATA[mid].start <= t) { idx = mid; lo = mid + 1; } else { hi = mid - 1; }
      }
      setActive(idx);
    }

    function setActive(idx) {
      if (idx === activeIdx) return;
      const prev = lyricsEl.querySelector('.line.active');
      if (prev) prev.classList.remove('active');

      const next = lyricsEl.querySelector(`.line[data-index="${idx}"]`);
      if (next) {
        next.classList.add('active');
        // scroll to center
        const top = next.offsetTop - lyricsEl.clientHeight / 2 + next.clientHeight / 2;
        lyricsEl.scrollTo({ top, behavior: 'smooth' });
      }
      activeIdx = idx;
    }

    function fmtTime(sec) {
      if (!isFinite(sec)) return '00:00';
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60), s = sec%60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    function updateClock() {
      clock.textContent = `${fmtTime(audio.currentTime)} / ${fmtTime(duration)}`;
    }

    // contoh detik beat (isi sesuai lagu)
    const BEATS = [3, 8, 11, 15, 19, 23, 28];

    let lastBeatIdx = -1;

    audio.addEventListener('timeupdate', () => {
    if (duration) seek.value = Math.round((audio.currentTime / duration) * 1000);
    syncLyrics(audio.currentTime);
    checkBeat(audio.currentTime);
    updateClock();
    });

    function checkBeat(t) {
    // cari beat berikutnya
    for (let i = 0; i < BEATS.length; i++) {
        if (Math.abs(t - BEATS[i]) < 0.2 && i !== lastBeatIdx) {
        triggerBoom();
        lastBeatIdx = i;
        break;
        }
    }
    }

    function triggerBoom() {
    const active = document.querySelector('.line.active');
    const photo = document.getElementById('pulse-photo');

    document.body.classList.add("flash");
    setTimeout(()=>document.body.classList.remove("flash"),200);

    [active, photo].forEach(el => {
        if (el) {
        el.classList.add('boom');
        setTimeout(() => el.classList.remove('boom'), 400);
        }
    });
    }


  </script>
</body>
</html>
